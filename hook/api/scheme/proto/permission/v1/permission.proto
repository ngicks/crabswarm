syntax = "proto3";

package permission.v1;

import "google/protobuf/timestamp.proto";

// PermissionService handles permission requests from Claude Code hooks.
service PermissionService {
  // RequestPermission sends a permission request to the interactive server
  // and returns the user's decision.
  rpc RequestPermission(PermissionRequest) returns (PermissionResponse);

  // Audit receives a stream of audit events from hook clients.
  // Each stream currently contains a single event from one hook invocation.
  // Client-streaming is chosen over unary for future extensibility
  // (e.g., a long-lived daemon client could reuse the stream).
  rpc Audit(stream AuditEvent) returns (AuditResponse);
}

// PermissionRequest contains the hook input from Claude Code.
message PermissionRequest {
  // The name of the hook being invoked (e.g., "PreToolUse", "PostToolUse").
  string hook_event_name = 1;
  // The name of the tool being used (e.g., "Bash", "Write", "Edit").
  string tool_name = 2;
  // The tool input as a JSON string.
  string tool_input_json = 3;
  // Session ID from Claude Code.
  string session_id = 4;
  // Message ID from Claude Code.
  string message_id = 5;
  // Current working directory.
  string cwd = 6;
  // Path to conversation transcript.
  string transcript_path = 7;
}

// PermissionResponse contains the decision from the interactive server.
message PermissionResponse {
  // Whether the agent should continue after this hook (default: true).
  bool should_continue = 1;
  // Message shown when should_continue is false.
  string stop_reason = 2;
  // Hide stdout from the transcript.
  bool suppress_output = 3;
  // Message injected into the conversation for Claude to see.
  string system_message = 4;
  // The hook-specific output.
  HookSpecificOutput hook_specific_output = 5;
}

// HookSpecificOutput contains hook-specific output data.
message HookSpecificOutput {
  // The hook event name this output is for.
  string hook_event_name = 1;
  // Permission decision: "allow", "deny", or "ask".
  PermissionDecision permission_decision = 2;
  // Explanation for the decision.
  string permission_decision_reason = 3;
  // Modified tool input as a JSON string (requires permission_decision ALLOW).
  string updated_input_json = 4;
  // Context added to the conversation.
  string additional_context = 5;
}

// PermissionDecision represents the possible permission decisions.
enum PermissionDecision {
  PERMISSION_DECISION_UNSPECIFIED = 0;
  // Allow the tool to proceed.
  PERMISSION_DECISION_ALLOW = 1;
  // Block the tool execution.
  PERMISSION_DECISION_DENY = 2;
  // Prompt the user for confirmation.
  PERMISSION_DECISION_ASK = 3;
}

// AuditEvent represents a hook invocation event for audit logging.
message AuditEvent {
  // The permission request data from the hook invocation.
  PermissionRequest request = 1;
  // The time the hook was invoked.
  google.protobuf.Timestamp timestamp = 2;
}

// AuditResponse is returned after processing all audit events in the stream.
message AuditResponse {
  // The number of events received in the stream.
  int32 events_received = 1;
  // Whether all events were processed successfully.
  bool success = 2;
  // Optional message with details about the processing result.
  string message = 3;
}
